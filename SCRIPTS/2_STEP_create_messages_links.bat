@echo off
chcp 65001 > nul
setlocal enabledelayedexpansion

:: Get the directory where this batch file is located
set "batch_dir=%~dp0"

echo Сейчас будут сохранены ссылки сообщений, которые надо запарсить
echo.

:: Активация виртуального окружения
echo Активация виртуального окружения...
call "%batch_dir%..\venv\Scripts\activate"

:: Запрос о необходимости пересоздания файла
echo.
echo Файл 2month_links.json будет пересоздан, если:
echo - вы запрашиваете данные за другой период времени
echo - вы запрашиваете данные для другой компании
echo - вы явно укажете необходимость пересоздания
echo.
set /p force_recreate="Пересоздать файл 2month_links.json? (y/N): "
if /i "!force_recreate!" == "y" (
    set force_param=--force-recreate
    echo Файл будет пересоздан
) else (
    set force_param=
    echo Будет использован существующий файл (если имеется)
)

:: Запрос ключевого слова для фильтрации
echo.
echo ______________________________________________________________________________
echo ФИЛЬТРАЦИЯ СООБЩЕНИЙ ПО КЛЮЧЕВОМУ СЛОВУ
echo Вы можете указать ключевое слово, чтобы оставить только нужные сообщения
echo Примеры:
echo   "Прекращение" - только сообщения о прекращении деятельности
echo   "Банкротство" - только сообщения о банкротстве
echo   "Реорганизация" - только сообщения о реорганизации
echo.
echo Совет: Оставьте поле пустым, если нужны ВСЕ сообщения
echo ______________________________________________________________________________
echo.
set /p keyword="Введите ключевое слово для фильтрации (или нажмите Enter для пропуска): "

if not "!keyword!" == "" (
    set keyword_param=--keyword "!keyword!"
    echo Будут отобраны только сообщения, содержащие: "!keyword!"
) else (
    set keyword_param=
    echo Будут обработаны ВСЕ сообщения (без фильтрации)
)

:: Запуск основного скрипта
echo.
echo Запуск скрипта подготовки ссылок сообщений...
python "%batch_dir%..\2prepare_message_links.py" !force_param! !keyword_param!

:: Проверка результата выполнения
if !errorlevel! equ 0 (
    echo.
    echo Успешно завершено!
    echo Ссылки на сообщения сохранены в 2month_links.json
) else (
    echo.
    echo Ошибка при выполнении скрипта (код: !errorlevel!)
)

pause